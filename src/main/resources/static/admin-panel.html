<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>EjectCloud - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" type="image/png" href="images/twitch-logo-transparent.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            overflow: hidden;
        }
        
        .hidden { display: none; }
        
        #error {
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            border-left: 5px solid #e74c3c;
        }
        
        #error h2 {
            color: #e74c3c;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        #app {
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            overflow-y: auto;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            border-right: 3px solid #db9215;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, #db9215 0%, #dea440 100%);
            font-weight: 600;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        }
        
        .nav-item {
            padding: 18px 25px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: rgba(219, 146, 21, 0.2);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #db9215 0%, #dea440 100%);
            box-shadow: 0 2px 10px rgba(219, 146, 21, 0.3);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }
        
        .toolbar {
            padding: 20px 25px;
            background: linear-gradient(135deg, #db9215 0%, #dea440 100%);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .toolbar h2 {
            font-weight: 600;
            font-size: 24px;
        }
        
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
            font-weight: 600;
        }
        
        .content-area {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #fafbfc;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-left: 4px solid #db9215;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-weight: 600;
            font-size: 18px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-weight: 600;
            color: #db9215;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #ecf0f1;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
            transition: width 0.3s ease;
            border-radius: 6px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        
        th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        tr:hover {
            background: linear-gradient(135deg, rgba(219, 146, 21, 0.05) 0%, rgba(222, 164, 64, 0.05) 100%);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        button.primary {
            background: linear-gradient(135deg, #db9215 0%, #dea440 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(219, 146, 21, 0.3);
        }
        
        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(219, 146, 21, 0.4);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }
        
        button.secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(127, 140, 141, 0.3);
        }
        
        button.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        button.danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        button.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }
        
        button.success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        input, select {
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #db9215;
            box-shadow: 0 0 0 3px rgba(219, 146, 21, 0.1);
        }
        
        .chart-container {
            height: 300px;
            margin: 15px 0;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .monitoring-grid {
            display: grid;
            gap: 25px;
            grid-template-columns: 1fr 1fr;
        }
        
        @media (max-width: 1400px) {
            .monitoring-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .storage-full {
            grid-column: 1 / -1;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        
        .form-field {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            display: block;
            color: #666;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .action-buttons button {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 8% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #db9215 0%, #dea440 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .close:hover {
            opacity: 1;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 25px;
        }
    </style>
</head>
<body>

<div id="error" class="hidden">
    <h2>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
    <p>–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞.</p>
    <p>–ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É <code>/admin</code> –≤ Telegram –±–æ—Ç–µ.</p>
</div>

<div id="app" class="hidden">
    <div class="sidebar">
        <div class="sidebar-header">
            üîß –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
        </div>
        <div class="nav-item active" onclick="showTab('dashboard')">üìä –î–∞—à–±–æ—Ä–¥</div>
        <div class="nav-item" onclick="showTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="nav-item" onclick="showTab('monitoring')">üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</div>
    </div>
    
    <div class="main-content">
        <div class="toolbar">
            <h2 id="pageTitle">–î–∞—à–±–æ—Ä–¥</h2>
            <div class="toolbar-right">
                <span id="who"></span>
                <span id="timer"></span>
                <button onclick="openUserInterface()" class="primary">üè† –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</button>
                <button onclick="logout()" class="danger">–í—ã—Ö–æ–¥</button>
            </div>
        </div>
        
        <div class="content-area">
            <!-- –î–∞—à–±–æ—Ä–¥ -->
            <div id="tab-dashboard">
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üíæ –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</h3>
                        <div class="metric">
                            <span>–í—Å–µ–≥–æ:</span>
                            <span class="metric-value" id="totalDisk">-</span>
                        </div>
                        <div class="metric">
                            <span>–°–≤–æ–±–æ–¥–Ω–æ:</span>
                            <span class="metric-value" id="freeDisk">-</span>
                        </div>
                        <div class="metric">
                            <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:</span>
                            <span class="metric-value" id="usedDisk">-</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="diskProgress"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üñ•Ô∏è –°–∏—Å—Ç–µ–º–∞</h3>
                        <div class="metric">
                            <span>CPU:</span>
                            <span class="metric-value" id="cpuUsage">-</span>
                        </div>
                        <div class="metric">
                            <span>–ü–∞–º—è—Ç—å:</span>
                            <span class="metric-value" id="memoryUsage">-</span>
                        </div>
                        <div class="metric">
                            <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</span>
                            <span class="metric-value" id="userCount">-</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üë• –ö–≤–æ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div class="metric">
                            <span>–û–±—â–∞—è –∫–≤–æ—Ç–∞:</span>
                            <span class="metric-value" id="totalQuota">-</span>
                        </div>
                        <div class="metric">
                            <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:</span>
                            <span class="metric-value" id="totalUsed">-</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="quotaProgress"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üìä –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</h3>
                    <table id="topUsersTable">
                        <thead>
                            <tr>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
                                <th>–ö–≤–æ—Ç–∞</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
            <div id="tab-users" class="hidden">
                <div class="card" style="margin-bottom: 25px;">
                    <h3>üë§ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="form-label">Email –∞–¥—Ä–µ—Å</label>
                            <input id="newEmail" type="email" />
                        </div>
                        <div class="form-field">
                            <label class="form-label">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                            <input id="newDisplayName" />
                        </div>
                        <div class="form-field">
                            <label class="form-label">ID –≤ Telegram</label>
                            <input id="newTelegramId" />
                        </div>
                        <div class="form-field">
                            <label class="form-label">–ö–≤–æ—Ç–∞ (MB)</label>
                            <input id="newQuota" type="number" value="1024" />
                        </div>
                        <button onclick="createUser()" class="primary">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>–ò–º—è</th>
                                <th>Email</th>
                                <th>Telegram ID</th>
                                <th>–ö–≤–æ—Ç–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ -->
            <div id="tab-monitoring" class="hidden">
                <div class="monitoring-grid">
                    <div class="card">
                        <h3>üìà CPU Usage</h3>
                        <div style="margin-bottom: 15px;">
                            <select id="cpuPeriod" onchange="loadHistory(this.value, 'cpu')">
                                <option value="5m">5 –º–∏–Ω—É—Ç</option>
                                <option value="30m">30 –º–∏–Ω—É—Ç</option>
                                <option value="1h" selected>1 —á–∞—Å</option>
                                <option value="3h">3 —á–∞—Å–∞</option>
                                <option value="6h">6 —á–∞—Å–æ–≤</option>
                                <option value="12h">12 —á–∞—Å–æ–≤</option>
                                <option value="24h">24 —á–∞—Å–∞</option>
                                <option value="3d">3 —Å—É—Ç–æ–∫</option>
                                <option value="10d">10 –¥–Ω–µ–π</option>
                                <option value="30d">30 –¥–Ω–µ–π</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="cpuChart" width="600" height="280"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üíæ Memory Usage</h3>
                        <div style="margin-bottom: 15px;">
                            <select id="memoryPeriod" onchange="loadHistory(this.value, 'memory')">
                                <option value="5m">5 –º–∏–Ω—É—Ç</option>
                                <option value="30m">30 –º–∏–Ω—É—Ç</option>
                                <option value="1h" selected>1 —á–∞—Å</option>
                                <option value="3h">3 —á–∞—Å–∞</option>
                                <option value="6h">6 —á–∞—Å–æ–≤</option>
                                <option value="12h">12 —á–∞—Å–æ–≤</option>
                                <option value="24h">24 —á–∞—Å–∞</option>
                                <option value="3d">3 —Å—É—Ç–æ–∫</option>
                                <option value="10d">10 –¥–Ω–µ–π</option>
                                <option value="30d">30 –¥–Ω–µ–π</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="memoryChart" width="600" height="280"></canvas>
                        </div>
                    </div>
                    
                    <div class="card storage-full">
                        <h3>üíø Storage Usage</h3>
                        <div style="margin-bottom: 15px;">
                            <select id="storagePeriod" onchange="loadHistory(this.value, 'storage')">
                                <option value="5m">5 –º–∏–Ω—É—Ç</option>
                                <option value="30m">30 –º–∏–Ω—É—Ç</option>
                                <option value="1h" selected>1 —á–∞—Å</option>
                                <option value="3h">3 —á–∞—Å–∞</option>
                                <option value="6h">6 —á–∞—Å–æ–≤</option>
                                <option value="12h">12 —á–∞—Å–æ–≤</option>
                                <option value="24h">24 —á–∞—Å–∞</option>
                                <option value="3d">3 —Å—É—Ç–æ–∫</option>
                                <option value="10d">10 –¥–Ω–µ–π</option>
                                <option value="30d">30 –¥–Ω–µ–π</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="storageChart" width="1200" height="280"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <span class="close" onclick="closeEditUserModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="display: grid; gap: 20px;">
                <div class="form-field">
                    <label class="form-label">Email –∞–¥—Ä–µ—Å</label>
                    <input id="editEmail" type="email" />
                </div>
                <div class="form-field">
                    <label class="form-label">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                    <input id="editDisplayName" />
                </div>
                <div class="form-field">
                    <label class="form-label">ID –≤ Telegram</label>
                    <input id="editTelegramId" />
                </div>
                <div class="form-field">
                    <label class="form-label">–ö–≤–æ—Ç–∞ (MB)</label>
                    <input id="editQuota" type="number" />
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeEditUserModal()" class="secondary">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveUserEdit()" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentUser = null;
let accessToken = null;
let refreshToken = null;
let refreshInterval = null;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const oldToken = urlParams.get('token');
    
    accessToken = localStorage.getItem('eject_access_token');
    refreshToken = localStorage.getItem('eject_refresh_token');
    
    if (accessToken) {
        validateToken();
    } else {
        window.location.href = '/login.html';
    }
};

function convertOldToken(oldToken) {
    fetch('/auth/login?token=' + oldToken, { method: 'POST' })
        .then(r => {
            if (!r.ok) throw new Error('Invalid token');
            return r.json();
        })
        .then(data => {
            accessToken = data.accessToken;
            refreshToken = data.refreshToken;
            localStorage.setItem('admin_access_token', accessToken);
            localStorage.setItem('admin_refresh_token', refreshToken);
            
            currentUser = data.telegramId;
            document.getElementById('who').textContent = currentUser;
            document.getElementById('app').classList.remove('hidden');
            
            startTokenRefresh();
            loadDashboard();
            setInterval(loadDashboard, 30000);
        })
        .catch(e => showError());
}

function validateToken() {
    fetch('/api/auth/validate?token=' + accessToken)
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                currentUser = data.user;
                document.getElementById('who').textContent = currentUser;
                document.getElementById('app').classList.remove('hidden');
                
                startTokenRefresh();
                loadDashboard();
                setInterval(loadDashboard, 30000);
            } else {
                tryRefreshToken();
            }
        })
        .catch(e => tryRefreshToken());
}

function tryRefreshToken() {
    if (!refreshToken) {
        showError();
        return;
    }
    
    fetch('/api/auth/refresh?refreshToken=' + refreshToken, { method: 'POST' })
        .then(r => {
            if (!r.ok) throw new Error('Refresh failed');
            return r.json();
        })
        .then(data => {
            accessToken = data.accessToken;
            localStorage.setItem('eject_access_token', accessToken);
            validateToken();
        })
        .catch(e => {
            console.error('Refresh error:', e);
            logout();
        });
}

function startTokenRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
    refreshInterval = setInterval(() => {
        tryRefreshToken();
    }, 10 * 60 * 1000);
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
    document.getElementById('timer').style.display = 'none';
}

function showError() {
    window.location.href = '/login.html';
}

function logout() {
    if (refreshToken) {
        fetch('/api/auth/logout?refreshToken=' + refreshToken, { method: 'POST' })
            .catch(() => {});
    }
    
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    
    localStorage.removeItem('eject_access_token');
    localStorage.removeItem('eject_refresh_token');
    accessToken = null;
    refreshToken = null;
    window.location.href = '/login.html';
}

function showTab(tabName) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('[id^="tab-"]').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    document.getElementById('tab-' + tabName).classList.remove('hidden');
    
    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    event.target.classList.add('active');
    
    // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const titles = {
        'dashboard': '–î–∞—à–±–æ—Ä–¥',
        'users': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', 
        'monitoring': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥'
    };
    document.getElementById('pageTitle').textContent = titles[tabName];
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    if (tabName === 'users') {
        loadUsers();
    } else if (tabName === 'monitoring') {
        loadHistory('1h', 'cpu');
        loadHistory('1h', 'memory');
        loadHistory('1h', 'storage');
    }
}

function loadDashboard() {
    if (!accessToken) {
        logout();
        return;
    }
    
    fetch('/admin/api/dashboard?token=' + accessToken)
        .then(r => {
            if (r.status === 401) {
                logout();
                return;
            }
            return r.json();
        })
        .then(data => {
            if (data) {
                updateSystemMetrics(data.system);
                updateUserMetrics(data.users);
                updateTopUsers(data.users.list);
            }
        })
        .catch(e => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞:', e));
}

function updateSystemMetrics(system) {
    const totalGB = (system.totalDiskSpace / 1024 / 1024 / 1024).toFixed(1);
    const freeGB = (system.freeDiskSpace / 1024 / 1024 / 1024).toFixed(1);
    const usedGB = (totalGB - freeGB).toFixed(1);
    const diskPercent = ((usedGB / totalGB) * 100).toFixed(1);
    
    document.getElementById('totalDisk').textContent = totalGB + ' GB';
    document.getElementById('freeDisk').textContent = freeGB + ' GB';
    document.getElementById('usedDisk').textContent = usedGB + ' GB (' + diskPercent + '%)';
    document.getElementById('diskProgress').style.width = diskPercent + '%';
    
    document.getElementById('cpuUsage').textContent = system.cpuUsage.toFixed(1) + '%';
    
    const memoryPercent = ((system.memoryUsed / system.memoryTotal) * 100).toFixed(1);
    const memoryMB = (system.memoryUsed / 1024 / 1024).toFixed(0);
    document.getElementById('memoryUsage').textContent = memoryMB + ' MB (' + memoryPercent + '%)';
}

function updateUserMetrics(users) {
    document.getElementById('userCount').textContent = users.count;
    
    const totalQuotaGB = (users.totalQuota / 1024 / 1024 / 1024).toFixed(1);
    const totalUsedGB = (users.totalUsed / 1024 / 1024 / 1024).toFixed(1);
    const quotaPercent = users.totalQuota > 0 ? ((users.totalUsed / users.totalQuota) * 100).toFixed(1) : 0;
    
    document.getElementById('totalQuota').textContent = totalQuotaGB + ' GB';
    document.getElementById('totalUsed').textContent = totalUsedGB + ' GB (' + quotaPercent + '%)';
    document.getElementById('quotaProgress').style.width = quotaPercent + '%';
}

function updateTopUsers(usersList) {
    const tbody = document.querySelector('#topUsersTable tbody');
    tbody.innerHTML = '';
    
    usersList
        .sort((a, b) => b.usedBytes - a.usedBytes)
        .slice(0, 5)
        .forEach(user => {
            const row = tbody.insertRow();
            const usedMB = Math.round(user.usedBytes / 1024 / 1024);
            const quotaMB = Math.round(user.quotaBytes / 1024 / 1024);
            const percent = quotaMB > 0 ? ((usedMB / quotaMB) * 100).toFixed(1) : 0;
            
            row.innerHTML = `
                <td>${user.username}</td>
                <td>${usedMB} MB</td>
                <td>${quotaMB} MB</td>
                <td>${percent}%</td>
            `;
        });
}

function loadUsers() {
    if (!accessToken) {
        logout();
        return;
    }
    
    fetch('/admin/api/users?token=' + accessToken)
        .then(r => {
            if (r.status === 401) {
                logout();
                return;
            }
            return r.json();
        })
        .then(users => {
            if (!users) return;
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = tbody.insertRow();
                const quotaMB = Math.round(user.quotaBytes / 1024 / 1024);
                const usedMB = Math.round(user.usedBytes / 1024 / 1024);
                const usagePercent = user.usagePercent || 0;
                
                row.innerHTML = `
                    <td>${user.displayName}</td>
                    <td>${user.email}</td>
                    <td>${user.telegramId || '-'}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                                <div style="height: 100%; background: ${usagePercent > 90 ? '#dc3545' : usagePercent > 70 ? '#ffc107' : '#28a745'}; width: ${Math.min(100, usagePercent)}%; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 12px; white-space: nowrap;">${usedMB} MB / ${quotaMB} MB</span>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="openEditUserModal('${user.id}', '${user.email}', '${user.displayName}', '${user.telegramId}', ${quotaMB})" class="primary">‚úèÔ∏è</button>
                            <button onclick="resetPassword('${user.id}')" class="secondary">üîë</button>
                            <button onclick="deleteUser('${user.id}', '${user.displayName}')" class="danger">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            });
        })
        .catch(e => alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + e.message));
}

function createUser() {
    const email = document.getElementById('newEmail').value;
    const displayName = document.getElementById('newDisplayName').value;
    const telegramId = document.getElementById('newTelegramId').value;
    const quotaMB = document.getElementById('newQuota').value;
    
    if (!email || !displayName || !telegramId || !quotaMB) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }
    
    if (!accessToken) {
        logout();
        return;
    }
    
    const params = new URLSearchParams();
    params.append('token', accessToken);
    params.append('email', email);
    params.append('displayName', displayName);
    params.append('telegramId', telegramId);
    params.append('quotaBytes', quotaMB * 1024 * 1024);
    
    fetch('/admin/api/users', {
        method: 'POST',
        body: params
    })
    .then(r => {
        if (!r.ok) return r.text().then(t => { throw new Error(t); });
        return r.json();
    })
    .then(() => {
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
        loadUsers();
        document.getElementById('newEmail').value = '';
        document.getElementById('newDisplayName').value = '';
        document.getElementById('newTelegramId').value = '';
        document.getElementById('newQuota').value = '1024';
    })
    .catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
}

function updateQuota(telegramId) {
    const quotaMB = document.getElementById(`quota_${telegramId}`).value;
    const quotaBytes = quotaMB * 1024 * 1024;
    
    if (!accessToken) {
        logout();
        return;
    }
    
    const params = new URLSearchParams();
    params.append('token', accessToken);
    params.append('telegramId', telegramId);
    params.append('quotaBytes', quotaBytes);
    
    fetch('/admin/api/quota', {
        method: 'POST',
        body: params
    })
    .then(r => {
        if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        alert('–ö–≤–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        loadUsers();
        loadDashboard(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥
    })
    .catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
}

function loadHistory(period = '1h', type = 'cpu') {
    if (!accessToken) {
        logout();
        return;
    }
    
    fetch('/admin/api/system/history?token=' + accessToken + '&period=' + period)
        .then(r => {
            if (r.status === 401) {
                logout();
                return;
            }
            return r.json();
        })
        .then(data => {
            if (data) {
                drawChart(data.entries, type);
            }
        })
        .catch(e => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', e));
}

function drawChart(entries, type) {
    const canvasId = type + 'Chart';
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!entries || entries.length === 0) {
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    const padding = 50;
    const bottomPadding = 30;
    const chartWidth = canvas.width - 2 * padding;
    const chartHeight = canvas.height - padding - bottomPadding;
    
    // –û—Å–∏
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, padding + chartHeight);
    ctx.lineTo(padding + chartWidth, padding + chartHeight);
    ctx.stroke();
    
    // –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    let maxValue = 100;
    let unit = '%';
    let values = [];
    
    entries.forEach(entry => {
        if (type === 'cpu') {
            values.push(entry.cpuUsage);
        } else if (type === 'memory') {
            values.push(entry.memoryUsed / 1024 / 1024 / 1024); // –≤ GB
        } else if (type === 'storage') {
            values.push(((entry.totalDiskSpace - entry.freeDiskSpace) / entry.totalDiskSpace) * 100);
        }
    });
    
    if (type === 'memory') {
        maxValue = Math.ceil(Math.max(...values));
        unit = 'GB';
    } else {
        maxValue = Math.max(100, Math.ceil(Math.max(...values)));
    }
    
    // –®–∫–∞–ª–∞ Y
    ctx.fillStyle = '#666';
    ctx.font = '10px Arial';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 5; i++) {
        const y = padding + (chartHeight / 5) * i;
        const value = maxValue - (i * maxValue / 5);
        ctx.fillText(value.toFixed(type === 'memory' ? 1 : 0) + unit, padding - 5, y + 3);
        
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(padding + chartWidth, y);
        ctx.stroke();
    }
    
    // –®–∫–∞–ª–∞ X (–≤—Ä–µ–º—è)
    const period = document.getElementById(type + 'Period').value;
    const timeLabels = getTimeLabels(entries, period);
    ctx.fillStyle = '#666';
    ctx.font = '9px Arial';
    ctx.textAlign = 'center';
    
    const labelCount = Math.min(6, timeLabels.length);
    for (let i = 0; i < labelCount; i++) {
        const x = padding + (i / (labelCount - 1)) * chartWidth;
        const labelIndex = Math.floor((i / (labelCount - 1)) * (timeLabels.length - 1));
        ctx.fillText(timeLabels[labelIndex], x, padding + chartHeight + 15);
    }
    
    // –ì—Ä–∞—Ñ–∏–∫
    if (entries.length > 1) {
        ctx.strokeStyle = type === 'cpu' ? '#e74c3c' : type === 'memory' ? '#3498db' : '#27ae60';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        values.forEach((value, index) => {
            const x = padding + (index / (values.length - 1)) * chartWidth;
            const y = padding + chartHeight - (value / maxValue) * chartHeight;
            
            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        
        ctx.stroke();
    }
}

function getTimeLabels(entries, period) {
    return entries.map(entry => {
        const date = new Date(entry.timestamp);
        if (['5m', '30m', '1h'].includes(period)) {
            return date.toLocaleTimeString('ru', {hour: '2-digit', minute: '2-digit'});
        } else if (['3h', '6h', '12h', '24h'].includes(period)) {
            return date.toLocaleTimeString('ru', {hour: '2-digit', minute: '2-digit'});
        } else {
            return date.toLocaleDateString('ru', {day: '2-digit', month: '2-digit'});
        }
    });
}

let editingUserId = null;

function openEditUserModal(userId, email, displayName, telegramId, quotaMB) {
    editingUserId = userId;
    document.getElementById('editEmail').value = email;
    document.getElementById('editDisplayName').value = displayName;
    document.getElementById('editTelegramId').value = telegramId || '';
    document.getElementById('editQuota').value = quotaMB;
    document.getElementById('editUserModal').style.display = 'block';
}

function closeEditUserModal() {
    document.getElementById('editUserModal').style.display = 'none';
    editingUserId = null;
}

function saveUserEdit() {
    if (!editingUserId) return;
    
    const newEmail = document.getElementById('editEmail').value;
    const newDisplayName = document.getElementById('editDisplayName').value;
    const newTelegramId = document.getElementById('editTelegramId').value;
    const newQuotaMB = document.getElementById('editQuota').value;
    
    if (!newEmail || !newDisplayName || !newTelegramId || !newQuotaMB) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }
    
    if (!accessToken) {
        logout();
        return;
    }
    
    const params = new URLSearchParams();
    params.append('token', accessToken);
    params.append('userId', editingUserId);
    params.append('email', newEmail);
    params.append('displayName', newDisplayName);
    params.append('telegramId', newTelegramId);
    params.append('quotaBytes', newQuotaMB * 1024 * 1024);
    
    fetch('/admin/api/users/edit', {
        method: 'POST',
        body: params
    })
    .then(r => {
        if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
        closeEditUserModal();
        loadUsers();
        loadDashboard();
    })
    .catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
}

function openUserInterface() {
    window.location.href = '/';
}

function resetPassword(userId) {
    if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å? –ü–∞—Ä–æ–ª—å —Å—Ç–∞–Ω–µ—Ç —Ä–∞–≤–Ω—ã–º email—É.')) {
        return;
    }
    
    if (!accessToken) {
        logout();
        return;
    }
    
    const params = new URLSearchParams();
    params.append('token', accessToken);
    params.append('userId', userId);
    
    fetch('/admin/api/reset-password', {
        method: 'POST',
        body: params
    })
    .then(r => {
        if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        alert('–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω');
    })
    .catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
}

function deleteUser(userId, displayName) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${displayName}? –í—Å–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!`)) {
        return;
    }
    
    if (!accessToken) {
        logout();
        return;
    }
    
    const params = new URLSearchParams();
    params.append('token', accessToken);
    params.append('userId', userId);
    
    fetch('/admin/api/users/delete', {
        method: 'POST',
        body: params
    })
    .then(r => {
        if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
        loadUsers();
        loadDashboard();
    })
    .catch(e => alert('–û—à–∏–±–∫–∞: ' + e.message));
}
</script>
</body>
</html>